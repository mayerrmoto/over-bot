import os
import asyncio
import logging
from datetime import datetime, time

from aiogram import Bot, Dispatcher, Router, types
from aiogram.filters import Command
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.webhook.aiohttp_server import SimpleRequestHandler, setup_application

from aiohttp import web

logging.basicConfig(level=logging.INFO)

TOKEN = os.getenv("8577816652:AAF77vcB83x5tEHDK__i456Wkig48TravzA
")
OPERATOR_ID = int(os.getenv("8497016432"))

bot = Bot(token=TOKEN)
dp = Dispatcher()
router = Router()


# ---------------- FSM ---------------- #

class Form(StatesGroup):
    name = State()
    car_model = State()
    car_year = State()
    problem = State()


# ---------------- Ð’Ñ€ÐµÐ¼Ñ ---------------- #

def is_work_time() -> bool:
    now = datetime.now().time()
    start = time(10, 0)
    end = time(20, 0)
    return start <= now <= end


# ---------------- ÐšÐ½Ð¾Ð¿ÐºÐ° ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð° ---------------- #

share_contact_kb = ReplyKeyboardMarkup(
    keyboard=[[KeyboardButton(text="ðŸ“± ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð¼", request_contact=True)]],
    resize_keyboard=True,
    one_time_keyboard=True
)


# ---------------- Ð¡Ñ‚Ð°Ñ€Ñ‚ ---------------- #

@router.message(Command("start"))
async def start_handler(message: types.Message, state: FSMContext):
    await state.clear()

    await message.answer(
        "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! ðŸ‘‹\n"
        "Ð¯ Overâ€‘Ð±Ð¾Ñ‚ Ð°Ð²Ñ‚Ð¾ÑÐµÑ€Ð²Ð¸ÑÐ° Overdrive Auto. ÐŸÐ¾Ð¼Ð¾Ð³Ð°ÑŽ Ð±Ñ‹ÑÑ‚Ñ€Ð¾ Ð¾Ñ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð·Ð°ÑÐ²ÐºÑƒ Ð¸ Ð¿ÐµÑ€ÐµÐ´Ð°Ð¼ ÐµÑ‘ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ.\n"
        "ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ñ‡Ñ‚Ð¾ Ð²Ð°Ñ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÐµÑ‚ ðŸš—",
        reply_markup=share_contact_kb
    )

    await message.answer("ÐšÐ°Ðº Ð¼Ð¾Ð³Ñƒ Ðº Ð²Ð°Ð¼ Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ? ðŸ™‚")
    await state.set_state(Form.name)


# ---------------- Ð”Ð½ÐµÐ²Ð½Ð¾Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ ---------------- #

async def send_to_operator(data, user_id):
    text = (
        "ÐÐ¾Ð²Ð°Ñ Ð·Ð°ÑÐ²ÐºÐ° â˜€ï¸\n\n"
        f"Ð˜Ð¼Ñ: {data['name']}\n"
        f"ÐÐ²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒ: {data['car_model']}\n"
        f"Ð“Ð¾Ð´: {data['car_year']}\n"
        f"Ð—Ð°Ð¿Ñ€Ð¾Ñ: {data['problem']}\n\n"
        f"ID ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: {user_id}\n"
        f"Ð’Ñ€ÐµÐ¼Ñ: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n"
        "Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº: Telegram Overâ€‘Ð±Ð¾Ñ‚"
    )

    await bot.send_message(OPERATOR_ID, text)


# ---------------- Ð’ÐµÑ‡ÐµÑ€Ð½Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ ---------------- #

async def send_to_operator_night(data, user_id):
    text = (
        "ÐÐ¾Ð²Ð°Ñ Ð·Ð°ÑÐ²ÐºÐ° ðŸŒ™\n\n"
        f"Ð˜Ð¼Ñ: {data['name']}\n"
        f"ÐÐ²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒ: {data['car_model']}\n"
        f"Ð“Ð¾Ð´: {data['car_year']}\n"
        f"Ð—Ð°Ð¿Ñ€Ð¾Ñ: {data['problem']}\n\n"
        f"ID ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: {user_id}\n"
        f"Ð’Ñ€ÐµÐ¼Ñ: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n"
        "Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº: Telegram Overâ€‘Ð±Ð¾Ñ‚"
    )

    await bot.send_message(OPERATOR_ID, text)


# ---------------- Ð¡Ð±Ð¾Ñ€ Ð´Ð°Ð½Ð½Ñ‹Ñ… ---------------- #

@router.message(Form.name)
async def process_name(message: types.Message, state: FSMContext):
    await state.update_data(name=message.text)
    await message.answer("Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸Ñ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¼Ð°Ñ€ÐºÑƒ Ð¸ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»Ñ ðŸš˜")
    await state.set_state(Form.car_model)


@router.message(Form.car_model)
async def process_car_model(message: types.Message, state: FSMContext):
    await state.update_data(car_model=message.text)
    await message.answer("ÐšÐ°ÐºÐ¾Ð¹ Ð³Ð¾Ð´ Ð²Ñ‹Ð¿ÑƒÑÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»Ñ? ðŸ“…")
    await state.set_state(Form.car_year)


@router.message(Form.car_year)
async def process_car_year(message: types.Message, state: FSMContext):
    await state.update_data(car_year=message.text)
    await message.answer("Ð§Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ? ÐžÐ¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ Ð¸Ð»Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑÐ»ÑƒÐ³Ñƒ ðŸ”§")
    await state.set_state(Form.problem)


@router.message(Form.problem)
async def process_problem(message: types.Message, state: FSMContext):
    await state.update_data(problem=message.text)
    data = await state.get_data()

    if is_work_time():
        await send_to_operator(data, message.from_user.id)
        await message.answer(
            "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! ðŸ™Œ Ð¯ Ð¾Ñ„Ð¾Ñ€Ð¼Ð¸Ð» Ð²Ð°ÑˆÑƒ Ð·Ð°ÑÐ²ÐºÑƒ Ð¸ Ð¿ÐµÑ€ÐµÐ´Ð°Ð» Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ.\n"
            "ÐžÐ±Ñ‹Ñ‡Ð½Ð¾ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… Ð¼Ð¸Ð½ÑƒÑ‚. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾ÑÑ‚Ð°Ð²Ð°Ð¹Ñ‚ÐµÑÑŒ Ð½Ð° ÑÐ²ÑÐ·Ð¸ ðŸ“²"
        )
    else:
        await send_to_operator_night(data, message.from_user.id)
        await message.answer(
            "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! ðŸ™Œ\n"
            "Ð¯ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ð» Ð²Ð°ÑˆÑƒ Ð·Ð°ÑÐ²ÐºÑƒ Ð¸ Ð¿ÐµÑ€ÐµÐ´Ð°Ð» ÐµÑ‘ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ.\n"
            "ÐœÑ‹ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð² Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ ðŸ“²"
        )

    await state.clear()


# ---------------- ÐžÑ‚Ð²ÐµÑ‚Ñ‹ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ---------------- #

@router.message(lambda m: m.from_user.id == OPERATOR_ID)
async def operator_reply(message: types.Message):
    if not message.reply_to_message:
        await message.answer("ÐžÑ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ (reply) Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°.")
        return

    try:
        client_id = int(message.reply_to_message.text.split("ID ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: ")[1].split("\n")[0])
    except:
        await message.answer("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°.")
        return

    await bot.copy_message(
        chat_id=client_id,
        from_chat_id=OPERATOR_ID,
        message_id=message.message_id
    )

    await message.answer("ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ.")


# ---------------- Webhook ÑÐµÑ€Ð²ÐµÑ€ ---------------- #

async def main():
    dp.include_router(router)

    app = web.Application()
    webhook_handler = SimpleRequestHandler(dispatcher=dp, bot=bot)
    webhook_handler.register(app, path="/webhook")

    setup_application(app, dp, bot=bot)

    return app


if __name__ == "__main__":
    web.run_app(main(), host="0.0.0.0", port=int(os.getenv("PORT", 8080)))

